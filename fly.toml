app = "mastodon-3615-computer"

kill_signal = "SIGINT"
kill_timeout = 5

[deploy]
strategy = "bluegreen"
## Uncomment if you are upgrading Mastodon. See README.md for details.
# release_command = "bin/rails db:migrate"

[env]
LOCAL_DOMAIN = "3615.computer"
WEB_CONCURRENCY = "2"
OVERMIND_FORMATION = "sidekiq=2"
MALLOC_ARENA_MAX = "2"
MAX_THREADS = "15"
RAILS_ENV = "production"
RAILS_LOG_TO_STDOUT = "enabled"
RAILS_SERVE_STATIC_FILES = "false"
REDIS_HOST = "mastodon-3615-computer-redis.internal"
REDIS_PORT = "6379"
## Storage on S3 also requires secrets named AWS_ACCESS_KEY_ID and
## AWS_SECRET_ACCESS_KEY. If you use this, remove [mounts] below.
S3_ENABLED = "true"
S3_BUCKET = "3615-computer-mastodon"
S3_ALIAS_HOST = "mastodon-files.3615.computer"
S3_ENDPOINT = "https://dfe59bbab9f2a8b244d57744936adfc7.r2.cloudflarestorage.com/"
S3_PERMISSION = "private"
S3_PROTOCOL = "https"
# Source: https://www.cloudflare.com/ips-v4 + https://www.cloudflare.com/ips-v6
TRUSTED_PROXY_IP = "127.0.0.1/8,::1/128,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,fc00::/7,173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/13,104.24.0.0/14,172.64.0.0/13,131.0.72.0/22,2400:cb00::/32,2606:4700::/32,2803:f800::/32,2405:b500::/32,2405:8100::/32,2a06:98c0::/29,2c0f:f248::/32"

## If you point to Fly here, uncomment the proxy in Caddyfile
# S3_ALIAS_HOST=3615-computer.fly.dev
## Sending email via SMTP also requires secrets
## named SMTP_LOGIN and SMTP_PASSWORD
SMTP_SERVER = "smtp.sendgrid.net"
SMTP_PORT = "587"
SMTP_ENABLE_STARTTLS = "always"
SMTP_FROM_ADDRESS = "mastodon@3615.computer"

## Comment out this section if you use cloud storage
# [mounts]
#   source = "mastodon_uploads"
#   destination = "/opt/mastodon/public/system"

## If you uncomment this to scale up to more VMs,
##   - Remove the entire [mounts] section above
##   - Remove the OVERMIND_FORMATION env line above
##   - Uncomment `processes = ["rails"]` below in [[services]]
# [processes]
#   # If you need more web server workers, scale up this group
#   # by running `fly scale count rails=N
#   rails = "./overmind start -x sidekiq"
#   # If you need to run more sidekiq workers, scale up this group
#   # by running `fly scale count N --group sidekiq`
#   sidekiq = "bash -c 'bundle exec sidekiq -c $MAX_THREADS -q default,8 -q push,6 -q ingress,4 -q mailers,2 -q pull'"
#   # The schedule queue can only ever have one worker process at a time
#   # by running fly scale count 1 --group schedule
#   schedule = "bash -c 'bundle exec sidekiq -c $MAX_THREADS'"

[[statics]]
guest_path = "/opt/mastodon/public"
url_prefix = "/"

[[services]]
# processes = ["rails"]
internal_port = 8080
protocol = "tcp"

[[services.ports]]
handlers = ["http"]
port = 80

[[services.ports]]
handlers = ["tls", "http"]
port = 443

[[services.tcp_checks]]
grace_period = "15s"
interval = "15s"
restart_limit = 0
timeout = "2s"

[[services.http_checks]]
path = "/health"
grace_period = "30s"
interval = "15s"
restart_limit = 0
timeout = "2s"
